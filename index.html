<!doctype html>
<html lang="en-US">
  <head>
    <meta charset="utf-8" />
    <title>typ-js example</title>
  </head>
  <body>
    <textarea id="input" placeholder="Type here"></textarea>
    <input id="file" type="file"></input>
    
    <pre id="tree">
    </pre>
    <pre id="errors">
    </pre>
    <div id="output">
      Loading...
    </div>
    <button id="download">Download as PDF</button>

    <script>
      // For playing around in the REPL
      let typ;
      import("/pkg/typ_js.js").then(pkg => typ = pkg)
    </script>

    <script type="module">
      import init, { TypJs } from "./pkg/typ_js.js";

      const input = document.getElementById("input")
      const file = document.getElementById("file")
      const download = document.getElementById("download")
      const tree = document.getElementById("tree")
      const errors = document.getElementById("errors")
      const output = document.getElementById("output")

      init().then(() => {
        const typ = TypJs.new()
        output.innerHTML = typ.svg()
        tree.innerHTML = typ.list()

        input.addEventListener("input", () => {
          typ.set("main.typ", input.value)
          output.innerHTML = typ.svg()
          errors.innerHTML = JSON.stringify(typ.errors(), null, 4)
          console.log({err: typ.errors()})
        })

        file.addEventListener("change", async () => {
          const f = file.files[0]
          if (!f) return
          const data = await f.arrayBuffer()
          const array = new Uint8Array(data)

          typ.add(f.name, array)
          tree.innerHTML = JSON.stringify(typ.list(), null, 4)
          output.innerHTML = typ.svg()
        })

        download.addEventListener("click", () => {
          const file = new File([typ.pdf()], "typ-js-output.pdf")
          const link = document.createElement("a")
          link.href = URL.createObjectURL(file)
          link.download = "typ-js-output.pdf"
          link.click()
          link.remove()
        })
      });
    </script>
  </body>
</html>
